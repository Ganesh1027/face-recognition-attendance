<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Attendance - Attendance System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>ðŸ“· Webcam Attendance</h2>
            </div>
            <div class="nav-menu">
                <a href="{{ url_for('dashboard') }}" class="nav-link">Dashboard</a>
                <a href="{{ url_for('student_management') }}" class="nav-link">Manage Students</a>
                <a href="{{ url_for('webcam_attendance') }}" class="nav-link active">Mark Attendance</a>
                <a href="{{ url_for('attendance_report') }}" class="nav-link">Reports</a>
                <a href="{{ url_for('logout') }}" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <div class="container">
            <div class="page-header">
                <h1>Mark Attendance</h1>
                <p>Scan QR code, verify blink, and recognize face</p>
            </div>

            <div class="webcam-layout">
                <!-- Webcam Feed -->
                <div class="webcam-card">
                    <div class="webcam-container">
                        <video id="webcam" autoplay playsinline></video>
                        <canvas id="overlay"></canvas>
                    </div>
                    <div class="webcam-controls">
                        <button id="startBtn" class="btn btn-primary">Start Camera</button>
                        <button id="stopBtn" class="btn btn-danger" style="display: none;">Stop Camera</button>
                    </div>
                </div>

                <!-- Attendance Process -->
                <div class="process-card">
                    <h3>Attendance Process</h3>

                    <div class="process-steps">
                        <div class="step" id="step1">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h4>Scan QR Code</h4>
                                <p class="step-status">Waiting for QR code...</p>
                            </div>
                        </div>

                        <div class="step" id="step2">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h4>Student Details</h4>
                                <div id="studentDetails" class="student-info">
                                    <p class="text-muted">No student scanned</p>
                                </div>
                            </div>
                        </div>

                        <div class="step" id="step3">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h4>Blink Detection</h4>
                                <p class="step-status">Please blink when prompted</p>
                                <div id="blinkStatus"></div>
                            </div>
                        </div>

                        <div class="step" id="step4">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h4>Face Recognition</h4>
                                <p class="step-status">Verifying identity...</p>
                                <div id="faceStatus"></div>
                            </div>
                        </div>

                        <div class="step" id="step5">
                            <div class="step-number">5</div>
                            <div class="step-content">
                                <h4>Mark Attendance</h4>
                                <button id="markAttendanceBtn" class="btn btn-success" disabled>
                                    Mark Attendance
                                </button>
                                <div id="attendanceStatus"></div>
                            </div>
                        </div>
                    </div>

                    <button id="resetBtn" class="btn btn-secondary btn-block">Reset Process</button>
                </div>
            </div>
        </div>
    </div>

    <div id="messageBox" class="message-box"></div>

    <script>
        let webcamStream = null;
        let video = document.getElementById('webcam');
        let canvas = document.getElementById('overlay');
        let ctx = canvas.getContext('2d');
        let processInterval = null;
        let currentStudent = null;
        let blinkDetected = false;
        let faceRecognized = false;
        let currentStep = 1;

        // Start webcam
        document.getElementById('startBtn').addEventListener('click', async () => {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = webcamStream;

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };

                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('stopBtn').style.display = 'inline-block';

                showMessage('Camera started successfully', 'success');
                startProcessing();
            } catch (error) {
                showMessage('Error accessing webcam: ' + error.message, 'error');
            }
        });

        // Stop webcam
        document.getElementById('stopBtn').addEventListener('click', () => {
            stopCamera();
        });

        function stopCamera() {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
                webcamStream = null;
                video.srcObject = null;
            }
            if (processInterval) {
                clearInterval(processInterval);
            }
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
        }

        function startProcessing() {
            // Process frames more frequently for smoother experience
            processInterval = setInterval(() => {
                if (currentStep === 1) {
                    scanQRCode();
                } else if (currentStep === 3 && !blinkDetected) {
                    detectBlink();
                } else if (currentStep === 4 && !faceRecognized) {
                    recognizeFace();
                }
            }, 500); // Changed from 1000ms to 500ms for more responsive detection

            // Start continuous visual feedback loop
            startVisualFeedback();
        }

        function startVisualFeedback() {
            // Draw overlays continuously for live video effect
            function drawOverlays() {
                if (!webcamStream) return;

                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Redraw last detection data if available
                if (lastDetectionData) {
                    if (currentStep === 3 && lastDetectionData.type === 'blink') {
                        // Draw blink detection overlays
                        drawDetectionOverlay(lastDetectionData.data, lastDetectionData.isBlinking);
                    } else if (currentStep === 4 && lastDetectionData.type === 'face') {
                        // Draw face recognition overlays
                        if (lastDetectionData.faceLocation) {
                            const [top, right, bottom, left] = lastDetectionData.faceLocation;
                            const width = right - left;
                            const height = bottom - top;

                            drawFaceBox(left, top, width, height, lastDetectionData.color);

                            // Draw label
                            ctx.fillStyle = lastDetectionData.color;
                            ctx.font = 'bold 16px Arial';
                            ctx.fillText(lastDetectionData.label, left, top - 10);
                        }
                    }
                }

                requestAnimationFrame(drawOverlays);
            }

            drawOverlays();
        }

        let lastDetectionData = null;

        async function scanQRCode() {
            const frame = captureFrame();
            if (!frame) return;

            try {
                const response = await fetch('/api/process-frame', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frame: frame, mode: 'qr' })
                });

                const result = await response.json();

                if (result.success && result.student) {
                    currentStudent = result.student;
                    displayStudentDetails(result.student);
                    updateStep(2);
                    setTimeout(() => updateStep(3), 1000);
                }
            } catch (error) {
                console.error('QR scan error:', error);
            }
        }

        async function detectBlink() {
            const frame = captureFrame();
            if (!frame) return;

            try {
                const response = await fetch('/api/process-frame', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frame: frame, mode: 'blink' })
                });

                const result = await response.json();

                // Store detection data for continuous rendering
                if (result.detection_data) {
                    lastDetectionData = {
                        type: 'blink',
                        data: result.detection_data,
                        isBlinking: result.blink_detected
                    };
                    console.log('[Blink] Stored detection data:', lastDetectionData);
                }

                if (result.success && result.blink_detected) {
                    blinkDetected = true;
                    document.getElementById('blinkStatus').innerHTML =
                        '<span class="status-badge status-success">âœ“ Blink Detected</span>';
                    updateStep(4);
                }
            } catch (error) {
                console.error('Blink detection error:', error);
            }
        }

        async function recognizeFace() {
            const frame = captureFrame();
            if (!frame) return;

            try {
                const response = await fetch('/api/process-frame', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ frame: frame, mode: 'face' })
                });

                const result = await response.json();

                console.log('[Face Recognition] API Response:', result);
                console.log('[Face Recognition] Current Student:', currentStudent);

                // Store face detection data for continuous rendering
                if (result.face_location) {
                    // Determine color and label based on match status
                    let color = '#00ff00';  // Green for match
                    let label = 'Recognizing...';

                    if (result.success && result.student) {
                        if (result.student.roll_number === currentStudent.roll_number) {
                            color = '#00ff00';  // Green for verified
                            label = `âœ“ ${result.student.name} (${(result.student.confidence * 100).toFixed(1)}%)`;
                        } else {
                            color = '#ff0000';  // Red for mismatch
                            label = 'âœ— Face Mismatch';
                        }
                    }

                    lastDetectionData = {
                        type: 'face',
                        faceLocation: result.face_location,
                        color: color,
                        label: label
                    };
                    console.log('[Face] Stored detection data:', lastDetectionData);
                }

                if (result.success && result.student) {
                    console.log('[Face Recognition] Match found!', result.student);
                    // Verify it's the same student
                    if (result.student.roll_number === currentStudent.roll_number) {
                        faceRecognized = true;
                        document.getElementById('faceStatus').innerHTML =
                            `<span class="status-badge status-success">âœ“ Face Verified (${(result.student.confidence * 100).toFixed(1)}%)</span>`;
                        updateStep(5);
                        document.getElementById('markAttendanceBtn').disabled = false;
                    } else {
                        console.log('[Face Recognition] Roll number mismatch!', result.student.roll_number, 'vs', currentStudent.roll_number);
                        document.getElementById('faceStatus').innerHTML =
                            '<span class="status-badge status-error">âœ— Face Mismatch</span>';
                        showMessage('Face does not match QR code student', 'error');
                        setTimeout(resetProcess, 3000);
                    }
                } else {
                    console.log('[Face Recognition] No match or failed', result);
                }
            } catch (error) {
                console.error('Face recognition error:', error);
            }
        }

        function drawDetectionOverlay(detectionData, isBlinking) {
            // Clear previous drawings
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw face box
            if (detectionData.face) {
                const face = detectionData.face;
                const color = isBlinking ? '#ff9800' : '#00ff00';  // Orange if blinking, green otherwise
                drawFaceBox(face.x, face.y, face.w, face.h, color);

                // Add label
                ctx.fillStyle = color;
                ctx.font = '16px Arial';
                ctx.fillText(isBlinking ? 'BLINK DETECTED!' : 'Face Detected', face.x, face.y - 10);
            }

            // Draw eye markers
            if (detectionData.eyes && detectionData.eyes.length > 0) {
                ctx.strokeStyle = '#2196f3';  // Blue for eyes
                ctx.lineWidth = 2;

                detectionData.eyes.forEach(eye => {
                    // Draw circle around eye
                    const centerX = eye.x + eye.w / 2;
                    const centerY = eye.y + eye.h / 2;
                    const radius = Math.max(eye.w, eye.h) / 2;

                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
                    ctx.stroke();

                    // Draw crosshair
                    ctx.beginPath();
                    ctx.moveTo(centerX - 5, centerY);
                    ctx.lineTo(centerX + 5, centerY);
                    ctx.moveTo(centerX, centerY - 5);
                    ctx.lineTo(centerX, centerY + 5);
                    ctx.stroke();
                });
            }
        }

        function drawFaceBox(x, y, w, h, color) {
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, w, h);

            // Draw corner markers for better visibility
            const cornerLength = 20;
            ctx.beginPath();
            // Top-left
            ctx.moveTo(x, y + cornerLength);
            ctx.lineTo(x, y);
            ctx.lineTo(x + cornerLength, y);
            // Top-right
            ctx.moveTo(x + w - cornerLength, y);
            ctx.lineTo(x + w, y);
            ctx.lineTo(x + w, y + cornerLength);
            // Bottom-right
            ctx.moveTo(x + w, y + h - cornerLength);
            ctx.lineTo(x + w, y + h);
            ctx.lineTo(x + w - cornerLength, y + h);
            // Bottom-left
            ctx.moveTo(x + cornerLength, y + h);
            ctx.lineTo(x, y + h);
            ctx.lineTo(x, y + h - cornerLength);
            ctx.stroke();
        }

        document.getElementById('markAttendanceBtn').addEventListener('click', async () => {
            if (!currentStudent) return;

            const formData = new FormData();
            formData.append('roll_number', currentStudent.roll_number);
            formData.append('name', currentStudent.name);
            formData.append('branch', currentStudent.branch);

            try {
                const response = await fetch('/api/mark-attendance', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('attendanceStatus').innerHTML =
                        '<span class="status-badge status-success">âœ“ Attendance Marked Successfully</span>';
                    showMessage(result.message, 'success');
                    setTimeout(resetProcess, 3000);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Error marking attendance: ' + error.message, 'error');
            }
        });

        document.getElementById('resetBtn').addEventListener('click', resetProcess);

        function resetProcess() {
            currentStudent = null;
            blinkDetected = false;
            faceRecognized = false;
            currentStep = 1;

            document.getElementById('studentDetails').innerHTML = '<p class="text-muted">No student scanned</p>';
            document.getElementById('blinkStatus').innerHTML = '';
            document.getElementById('faceStatus').innerHTML = '';
            document.getElementById('attendanceStatus').innerHTML = '';
            document.getElementById('markAttendanceBtn').disabled = true;

            document.querySelectorAll('.step').forEach(step => step.classList.remove('active', 'completed'));
            updateStep(1);
        }

        function updateStep(stepNumber) {
            currentStep = stepNumber;

            document.querySelectorAll('.step').forEach((step, index) => {
                step.classList.remove('active');
                if (index + 1 < stepNumber) {
                    step.classList.add('completed');
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                }
            });
        }

        function displayStudentDetails(student) {
            document.getElementById('studentDetails').innerHTML = `
                <p><strong>Roll Number:</strong> ${student.roll_number}</p>
                <p><strong>Name:</strong> ${student.name}</p>
                <p><strong>Branch:</strong> <span class="badge">${student.branch}</span></p>
            `;
        }

        function captureFrame() {
            if (!video.videoWidth || !video.videoHeight) return null;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            return canvas.toDataURL('image/jpeg', 0.8);
        }

        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box message-${type} show`;

            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 5000);
        }

        // Initialize
        updateStep(1);
    </script>
</body>

</html>